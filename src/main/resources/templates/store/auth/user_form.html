<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>NovaBookğŸ“•</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <!--  ajax mix content  -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <!-- Google Font -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700|Raleway:400,300,500,700,600'
          rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.css"
          type="text/css">
    <!-- Theme Stylesheet -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <style>
        .button-container {
            text-align: center;
            margin-top: 20px; /* ë²„íŠ¼ë“¤ ì‚¬ì´ ê°„ê²© ì¡°ì • */
        }

        .button-container .but3, .button-container .but4 {
            margin: 0 10px; /* ë²„íŠ¼ë“¤ ì‚¬ì´ ê°„ê²© ì¡°ì • */
        }

        #register-button[disabled] {
            background-color: #ccc;
            border-color: #ccc;
            color: #555;
        }
    </style>
</head>
<body>
<div th:replace="~{layout/store/nav::nav}"></div>

<div class="register-container">

    <form method="post" action="/users/user/form" onsubmit="return formCheck(this);">
        <div class="container">
            <div class="insert">
                <table>
                    <caption><h2 th:text="#{user_form.title}">íšŒì›ê°€ì… ì–‘ì‹</h2></caption>
                    <tr>
                        <td class="col1" th:text="#{user_form.name}">ì´ë¦„</td>
                        <td class="col2"><input type="text" name="name" maxlength="20"></td>
                    </tr>
                    <tr>
                        <td class="col1" th:text="#{user_form.id}">ì•„ì´ë””</td>
                        <td class="col2">
                            <input type="text" id="loginId" name="loginId" maxlength="20"
                                   oninput="handleInputIdChange()">
                            <input class="but1" type="button" th:value="#{user_form.check.duplicate.id}" onclick="checkDuplicateId()">
                            <span id="idMessage" class="error-message"></span>
                        </td>
                    </tr>
                    <tr>
                        <td class="col1" th:text="#{user_form.password}">ë¹„ë°€ë²ˆí˜¸</td>
                        <td class="col2">
                            <input type="password" id="loginPassword" name="loginPassword" maxlength="16">
                            <p th:text="#{user_form.password.hint}">â€»ë¹„ë°€ë²ˆí˜¸ëŠ” ë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì(~!@#$%^&*)ì˜ ì¡°í•© 10 ~ 16ìë¦¬ë¡œ ì…ë ¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                        </td>
                    </tr>
                    <tr>
                        <td class="col1" th:text="#{user_form.password.confirm}">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</td>
                        <td class="col2">
                            <input type="password" id="loginPasswordConfirm" name="loginPasswordConfirm" maxlength="16">
                            <span id="passwordMessage"></span>
                        </td>
                    </tr>
                    <tr>
                        <td class="col1" th:text="#{user_form.email}">ì´ë©”ì¼</td>
                        <td class="col2">
                            <input type="text" id="email" name="email" oninput="handleInputEmailChange()">
                            <span class="a">@</span>
                            <input type="text" id="emailDomain" name="emailDomain">
                            <select name="mailslc" onchange="updateEmail()">
                                <option value="self" selected th:text="#{user_form.select}">ì§ì ‘ì…ë ¥</option>
                                <option value="naver">naver.com</option>
                                <option value="gm">gmail.com</option>
                                <option value="da">daum.com</option>
                                <option value="yah">yahoo.com</option>
                            </select>
                            <input class="but2" type="button" th:value="#{user_form.check.duplicate.email}" onclick="checkDuplicateEmail()">
                            <span id="emailMessage" class="error-message"></span>
                        </td>
                    </tr>
                    <tr>
                        <td class="col1" th:text="#{user_form.birthdate}">ìƒë…„ì›”ì¼</td>
                        <td class="col2">
                            <select id="birth_year" name="birthYear" class="col-sm-3">
                                <option value="none" th:text="#{user_form.select}">ì„ íƒ</option>
                                <script>
                                    for (let i = 2023; i >= 1900; i--) {
                                        document.write('<option value="' + i + '">' + i + '</option>');
                                    }
                                </script>
                            </select>
                            <select id="birth_month" name="birthMonth" class="col-sm-3">
                                <option value="none" th:text="#{user_form.select}">ì„ íƒ</option>
                                <script>
                                    for (let i = 1; i <= 12; i++) {
                                        document.write('<option value="' + i + '">' + i + '</option>');
                                    }
                                </script>
                            </select>
                            <select id="birth_day" name="birthDay" class="col-sm-3">
                                <option value="none" th:text="#{user_form.select}">ì„ íƒ</option>
                                <script>
                                    for (let i = 1; i <= 31; i++) {
                                        document.write('<option value="' + i + '">' + i + '</option>');
                                    }
                                </script>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="col1" th:text="#{user_form.address}">ì£¼ì†Œ</td>
                        <td class="col2">
                            <input type="text" id="postcode" name="postcode" readonly placeholder="ìš°í¸ë²ˆí˜¸">
                            <input class="but1" type="button" onclick="execPostcode()" th:value="#{user_form.find.postcode}">
                            <input type="text" id="address" name="address" readonly placeholder="ì£¼ì†Œ">
                            <input type="text" id="detailAddress" name="detailAddress" placeholder="ìƒì„¸ì£¼ì†Œ">
                            <input type="text" id="extraAddress" name="extraAddress" placeholder="ì°¸ê³ í•­ëª©">
                        </td>
                    </tr>
                    <tr>
                        <td class="col1" th:text="#{user_form.contact}">ì—°ë½ì²˜</td>
                        <td class="col2"><input type="text" name="contact"></td>
                    </tr>
                </table>
                <div class="button-container">
                    <input class="but3" id="register-button" type="submit" th:value="#{user_form.submit}" disabled>
                    <button class="but4" th:text="#{user_form.cancel}" onclick="location.href='/'"></button>
                </div>
            </div>
        </div>
    </form>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js"></script>
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script>
    // ìë°”ìŠ¤í¬ë¦½íŠ¸ í•¨ìˆ˜ë“¤
    // ì¤‘ë³µ í™•ì¸ì„ ìœ„í•œ í•¨ìˆ˜ë“¤
    function checkDuplicateId() {
        const loginId = $('#loginId').val();
        if (loginId.trim() === '') {
            alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        axios.get(`/api/users/check-duplicate-id?loginId=${loginId}`)
            .then(response => {
                if (response.data.duplicate) {
                    $('#idMessage').text("ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.").css('color', 'red');
                } else {
                    $('#idMessage').text("ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.").css('color', 'green');
                }
            })
            .catch(error => {
                console.error(error);
                alert("ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

    function checkDuplicateEmail() {
        const email = $('#email').val() + '@' + $('#emailDomain').val();
        if (email.trim() === '@') {
            alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        axios.get(`/api/users/check-duplicate-email?email=${email}`)
            .then(response => {
                if (response.data.duplicate) {
                    $('#emailMessage').text("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.").css('color', 'red');
                } else {
                    $('#emailMessage').text("ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤.").css('color', 'green');
                }
            })
            .catch(error => {
                console.error(error);
                alert("ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

    // ì´ë©”ì¼ ë„ë©”ì¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateEmail() {
        const emailSelect = $('select[name="mailslc"]').val();
        const emailDomain = $('#emailDomain');

        if (emailSelect === 'self') {
            emailDomain.val('').prop('readonly', false);
        } else {
            emailDomain.val(emailSelect).prop('readonly', true);
        }
    }

    // ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ í™•ì¸ í•¨ìˆ˜
    function validatePassword() {
        const password = $('#loginPassword').val();
        const confirmPassword = $('#loginPasswordConfirm').val();

        if (password !== confirmPassword) {
            $('#passwordMessage').text("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.").css('color', 'red');
            return false;
        } else {
            $('#passwordMessage').text("");
            return true;
        }
    }

    // ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
    function checkPasswordValidity() {
        const password = $('#loginPassword').val();
        const passwordRegex = /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[~!@#$%^&*]).{10,16}$/;

        if (!passwordRegex.test(password)) {
            alert("ë¹„ë°€ë²ˆí˜¸ëŠ” ë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì(~!@#$%^&*)ì˜ ì¡°í•© 10 ~ 16ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.");
            return false;
        }
        return true;
    }

    // í¼ ì œì¶œ ì „ í™•ì¸
    function formCheck(form) {
        const name = $('input[name="name"]').val().trim();
        const loginId = $('input[name="loginId"]').val().trim();
        const email = $('#email').val().trim() + '@' + $('#emailDomain').val().trim();
        const birthYear = $('#birth_year').val();
        const birthMonth = $('#birth_month').val();
        const birthDay = $('#birth_day').val();
        const address = $('#address').val().trim();
        const contact = $('input[name="contact"]').val().trim();

        if (name === '') {
            alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return false;
        }
        if (loginId === '') {
            alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return false;
        }
        if (!checkPasswordValidity()) {
            return false;
        }
        if (!validatePassword()) {
            return false;
        }
        if (email === '@') {
            alert("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return false;
        }
        if (birthYear === 'none' || birthMonth === 'none' || birthDay === 'none') {
            alert("ìƒë…„ì›”ì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return false;
        }
        if (address === '') {
            alert("ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return false;
        }
        if (contact === '') {
            alert("ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return false;
        }
        return true;
    }

    // ì£¼ì†Œ ì°¾ê¸° API
    function execPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                var fullAddr = ''; // ìµœì¢… ì£¼ì†Œ ë³€ìˆ˜
                var extraAddr = ''; // ì¡°í•©í˜• ì£¼ì†Œ ë³€ìˆ˜

                if (data.userSelectedType === 'R') {
                    fullAddr = data.roadAddress;
                } else {
                    fullAddr = data.jibunAddress;
                }

                if (data.userSelectedType === 'R') {
                    if (data.bname !== '') {
                        extraAddr += data.bname;
                    }
                    if (data.buildingName !== '') {
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    fullAddr += (extraAddr !== '' ? ' ('+ extraAddr +')' : '');
                }

                $('#postcode').val(data.zonecode);
                $('#address').val(fullAddr);
                $('#detailAddress').focus();
            }
        }).open();
    }

    function handleInputIdChange() {
        const idMessage = document.getElementById("idMessage");
        idMessage.textContent = "";
    }

    function handleInputEmailChange() {
        const emailMessage = document.getElementById("emailMessage");
        emailMessage.textContent = "";
    }
</script>
</body>
</html>
